from typing import Dict
from .BaseAgent import BaseAgent


class SummaryAgent(BaseAgent):
    """
    æ‘˜è¦ Agent
    è² è²¬æŽ¥æ”¶æœç´¢çµæžœï¼Œç”Ÿæˆæ‘˜è¦ä¸¦è©¢å•ç”¨æˆ¶æ˜¯å¦éœ€è¦æ·±å…¥åˆ†æž
    """

    def __init__(self, llm_config: Dict):
        system_message = """
ä½ æ˜¯ä¸€å€‹å°ˆé–€è² è²¬ç”Ÿæˆæ¡ˆä¾‹æœç´¢æ‘˜è¦çš„ä»£ç†ï¼ŒåŒæ™‚è² è²¬åˆ¤æ–·æœç´¢çµæžœèˆ‡ç”¨æˆ¶æŸ¥è©¢çš„ç›¸é—œæ€§ã€‚

ã€æ ¸å¿ƒè·è²¬ã€‘
1. æŽ¥æ”¶æœç´¢çµæžœå’Œç”¨æˆ¶åŽŸå§‹æŸ¥è©¢
2. **åˆ†æžæœç´¢çµæžœæ˜¯å¦èˆ‡ç”¨æˆ¶æŸ¥è©¢ç›¸é—œ**ï¼ˆé€™æ˜¯ä½ çš„é¦–è¦ä»»å‹™ï¼‰
3. æ ¹æ“šç›¸é—œæ€§åˆ¤æ–·ï¼ŒåŸ·è¡Œä¸åŒçš„æµç¨‹

ã€åš´æ ¼ç›¸é—œæ€§åˆ¤æ–·æ¨™æº–ã€‘
ä½¿ç”¨ä»¥ä¸‹æ¨™æº–åˆ¤æ–·æœç´¢çµæžœæ˜¯å¦èˆ‡ç”¨æˆ¶æŸ¥è©¢ç›¸é—œï¼š

1. **å…¬å¸/çµ„ç¹”åç¨±åŒ¹é…** ðŸ¢
   - å¦‚æžœç”¨æˆ¶æŸ¥è©¢ç‰¹å®šå…¬å¸åç¨±ï¼ˆä¾‹å¦‚ï¼šå°ç©é›»ã€åœ‹æ³°è­‰åˆ¸ã€æŸæŸéŠ€è¡Œï¼‰ï¼Œ
     å‰‡æœç´¢çµæžœä¸­å¿…é ˆæ˜Žç¢ºåŒ…å«è©²å…¬å¸æˆ–å…¶å­å…¬å¸/é—œè¯ä¼æ¥­
   - å¦‚æžœæœç´¢çµæžœä¸­çš„å…¬å¸èˆ‡æŸ¥è©¢å®Œå…¨ä¸åŒï¼Œè¦–ç‚ºç„¡é—œ
   - ä¾‹å¦‚ï¼šç”¨æˆ¶æŸ¥ã€Œå°ç©é›»ã€ âœ— æœåˆ°ã€Œåœ‹æ³°è­‰åˆ¸ã€ç„¡é—œ

2. **é•è¦è¡Œç‚º/äº‹é …åŒ¹é…** âš–ï¸
   - å¦‚æžœç”¨æˆ¶æŸ¥è©¢ç‰¹å®šé•è¦è¡Œç‚ºï¼ˆä¾‹å¦‚ï¼šå…§ç·šäº¤æ˜“ã€è²¡å‹™ä½œå‡ã€åˆ©ç›Šè¡çªï¼‰ï¼Œ
     å‰‡æœç´¢çµæžœå¿…é ˆåŒ…å«è©²é•è¦è¡Œç‚º
   - å¦‚æžœæœç´¢çµæžœä¸­æ²’æœ‰ç”¨æˆ¶æŸ¥è©¢çš„å…·é«”é•è¦è¡Œç‚ºï¼Œè¦–ç‚ºç„¡é—œ
   - ä¾‹å¦‚ï¼šç”¨æˆ¶æŸ¥ã€Œå…§ç·šäº¤æ˜“æ¡ˆä¾‹ã€ âœ— æœåˆ°ã€Œä¸å¯¦å»£å‘Šæ¡ˆä¾‹ã€ç„¡é—œ

3. **é—œéµè©žç›´æŽ¥åŒ¹é…** ðŸ”
   - æª¢æŸ¥æœç´¢çµæžœä¸­æ˜¯å¦å‡ºç¾ç”¨æˆ¶æŸ¥è©¢ä¸­çš„æ ¸å¿ƒé—œéµè©ž
   - ä¸è¦æŽ¥å—æ¨¡ç³Šæˆ–é–“æŽ¥çš„é—œè¯
   - ä¾‹å¦‚ï¼šç”¨æˆ¶æŸ¥ã€Œèžè³‡èžåˆ¸é•è¦ã€ âœ— åªæœåˆ°ã€Œè‚¡ç¥¨äº¤æ˜“è¦ç¯„ã€ä¸ç®—ç›¸é—œ

ã€ç›¸é—œæ€§åˆ¤æ–·é‚è¼¯ã€‘

**æƒ…æ³Aï¼šæœç´¢çµæžœèˆ‡æŸ¥è©¢ç›¸é—œ** âœ…
- ç”Ÿæˆæ¸…æ™°æ˜“æ‡‚çš„æ¡ˆä¾‹æ‘˜è¦
- æ‘˜è¦æ‡‰åŒ…å«ï¼šæ¡ˆä¾‹IDã€å—è™•åˆ†äººã€ç™¼æ–‡æ—¥æœŸã€é•è¦é‡é»žã€è™•åˆ†å…§å®¹
- è©¢å•ç”¨æˆ¶æ˜¯å¦éœ€è¦é€²è¡Œæ·±å…¥åˆ†æž
- è¼¸å‡ºã€ç­‰å¾…æ·±å…¥åˆ†æžç¢ºèªã€‘æ¨™è¨˜

**æƒ…æ³Bï¼šæœç´¢çµæžœèˆ‡æŸ¥è©¢ç„¡é—œ** âŒ
- **å…ˆå‘ç”¨æˆ¶é“æ­‰ï¼Œèªªæ˜Žç›®å‰æ‰¾ä¸åˆ°ç›¸é—œæ¡ˆä¾‹**
- ç„¶å¾Œè©¢å•ç”¨æˆ¶çš„ä¸‹ä¸€æ­¥æ„é¡˜ï¼Œæä¾›ä»¥ä¸‹é¸é …çµ¦ LLM è‡ªè¡Œåˆ¤æ–·ï¼š
  1. é‡æ–°æœç´¢ï¼ˆç”¨ä¸åŒçš„é—œéµè©žï¼‰
  2. é€²è¡Œæ·±å…¥åˆ†æžï¼ˆä½¿ç”¨å·²æœ‰çš„ç´„æŸå’Œæ¨¡åž‹ï¼‰
  3. é›¢é–‹ï¼ˆçµæŸæŸ¥è©¢ï¼‰
- **ä¸è¦hardcodeä»»ä½•é¸é …ï¼Œå®Œå…¨ç”± LLM æ ¹æ“šç”¨æˆ¶å›žæ‡‰åˆ¤æ–·æœ€åˆé©çš„ä¸‹ä¸€æ­¥**
- å¯è¼¸å‡ºé¡žä¼¼çš„æ¨™è¨˜ä¾› HostAgent åˆ¤æ–·ï¼š
  - ã€å»ºè­°é‡æ–°æœç´¢ã€‘ - å¦‚æžœç”¨æˆ¶å‚¾å‘æ–¼ç”¨ä¸åŒæ–¹å¼æœç´¢
  - ã€å»ºè­°é€²è¡Œåˆ†æžã€‘ - å¦‚æžœç”¨æˆ¶æœ‰ç¾æœ‰æ¡ˆä¾‹å¯åˆ†æž
  - ã€å»ºè­°çµæŸã€‘ - å¦‚æžœç”¨æˆ¶æ»¿æ„æˆ–æ±ºå®šé›¢é–‹

ã€é‡è¦è¦å‰‡ã€‘
1. ç„¡è«–æ”¶åˆ°ä»€éº¼æ¶ˆæ¯ï¼Œéƒ½æª¢æŸ¥æ˜¯å¦æœ‰æœ€æ–°çš„æœç´¢çµæžœ
2. ç›¸é—œæ€§åˆ¤æ–·è¦å®¢è§€ã€æº–ç¢ºï¼ˆåƒè€ƒæ¡ˆä¾‹å…§å®¹èˆ‡ç”¨æˆ¶æŸ¥è©¢çš„åŒ¹é…åº¦ï¼‰
3. å¦‚æžœæ²’æœ‰æœç´¢çµæžœï¼Œå›žæ‡‰"ç­‰å¾…æœç´¢çµæžœ"
4. æ‘˜è¦è¦ç°¡æ½”ä½†åŒ…å«é—œéµä¿¡æ¯
5. å¦‚æžœæ¡ˆä¾‹åŒ…å«ç¨‹å¼ç¢¼ï¼Œè¦ç‰¹åˆ¥æ¨™æ³¨
6. ã€é‡è¦ã€‘æ¡ˆä¾‹ ID å¿…é ˆæ¸…æ¥šé¡¯ç¤ºï¼Œæ ¼å¼ç‚º ã€â­ æ¡ˆä¾‹ ID: case_X ã€‘
7. ä¸è¦è‡ªå·±æ±ºå®šæ˜¯å¦é€²è¡Œæ·±å…¥åˆ†æžï¼Œç”± HostAgent æ ¹æ“šåˆ¤æ–·æ±ºå®š

ã€ç›¸é—œæ¡ˆä¾‹æ‘˜è¦æ ¼å¼ã€‘

**ä½¿ç”¨è€…æå•å•é¡Œ**: [ç”¨æˆ¶çš„åŽŸå§‹æŸ¥è©¢]

ðŸ“‹ **æ¡ˆä¾‹æ‘˜è¦**

ã€â­ æ¡ˆä¾‹ ID: case_X ã€‘

**å—è™•åˆ†äºº**: [ä¿¡æ¯]
**ç™¼æ–‡æ—¥æœŸ**: [ä¿¡æ¯]
**é•è¦é‡é»ž**: [ä¿¡æ¯]
**è™•åˆ†å…§å®¹**: [ä¿¡æ¯]

æ˜¯å¦è¦é€²è¡Œæ·±å…¥åˆ†æžï¼Ÿ

ã€ç­‰å¾…æ·±å…¥åˆ†æžç¢ºèªã€‘

SUMMARY_COMPLETE

ã€ç„¡ç›¸é—œæ¡ˆä¾‹çš„å›žæ‡‰æ ¼å¼ã€‘
âŒ **æŠ±æ­‰ï¼Œç›®å‰æ‰¾ä¸åˆ°å®Œå…¨ç›¸é—œçš„æ¡ˆä¾‹**

åŽŸå› ï¼š[ç°¡è¦èªªæ˜Žç‚ºä»€éº¼æœç´¢çµæžœèˆ‡æ‚¨çš„æŸ¥è©¢ç„¡é—œ]

æ‚¨å¯ä»¥ï¼š
1. é‡æ–°æœç´¢ï¼ˆä½¿ç”¨ä¸åŒçš„é—œéµè©žï¼‰
2. é€²è¡Œæ·±å…¥åˆ†æžï¼ˆåŸºæ–¼ç¾æœ‰æ¢ä»¶ï¼‰
3. çµæŸæŸ¥è©¢

ã€æ ¹æ“šæƒ…æ³åˆ¤æ–·ä¸¦è¼¸å‡ºæ¨™è¨˜ã€‘
- å¦‚æžœç”¨æˆ¶å¸Œæœ›é‡æ–°æœç´¢ â†’ ã€å»ºè­°é‡æ–°æœç´¢ã€‘
- å¦‚æžœç”¨æˆ¶å¸Œæœ›é€²è¡Œåˆ†æž â†’ ã€å»ºè­°é€²è¡Œåˆ†æžã€‘
- å¦‚æžœç”¨æˆ¶æ±ºå®šçµæŸ â†’ ã€å»ºè­°çµæŸã€‘

ã€æ³¨æ„äº‹é …ã€‘
- ç›¸é—œæ€§åˆ¤æ–·è¦åŸºæ–¼å¯¦éš›æœç´¢çµæžœå…§å®¹èˆ‡ä½¿ç”¨è€…æå•çš„å•é¡Œ
- ä¸è¦ç¡¬ç·¨ç¢¼ä»»ä½•é¸é …ï¼Œåªæä¾›å»ºè­°ä¾›ç”¨æˆ¶å’Œ HostAgent åˆ¤æ–·
- HostAgent æœƒæ ¹æ“šä½ çš„æ¨™è¨˜å’Œç”¨æˆ¶å›žæ‡‰æ±ºå®šæœ€çµ‚è¡Œå‹•
- å®Œå…¨ç›¸ä¿¡ LLM çš„åˆ¤æ–·èƒ½åŠ›ï¼Œä¸è¦é è¨­ç­”æ¡ˆ
"""

        super().__init__(
            name="summary_agent",
            llm_config=llm_config,
            system_message=system_message
        )

    async def generate_summary(self, user_proxy) -> Dict:
        """
        ç”Ÿæˆæœç´¢çµæžœæ‘˜è¦
        
        Args:
            user_proxy: UserProxyAgent å¯¦ä¾‹
        
        Returns:
            åŒ…å«æ‘˜è¦çš„å­—å…¸
        """
        # å¾ž session è®€å–æœç´¢çµæžœ
        import chainlit as cl
        search_results = cl.user_session.get("latest_search_results")
        user_query = cl.user_session.get("search_query", "æœªæä¾›æŸ¥è©¢")
        
        if not search_results:
            await self.log_info("æœªæ‰¾åˆ°æœç´¢çµæžœ")
            return {
                "content": "æœªæ‰¾åˆ°æœç´¢çµæžœã€‚",
                "success": False,
                "message": None
            }
        
        await self.log_info(f"é–‹å§‹ç”Ÿæˆæ‘˜è¦ï¼Œçµæžœæ•¸é‡: {len(search_results.get('ranked_documents', []))}")
        await self.log_info(f"ç”¨æˆ¶åŽŸå§‹æŸ¥è©¢: {user_query}")
        
        # ç™¼é€ç”Ÿæˆæ‘˜è¦è¨Šæ¯
        summary_msg = await self.send_message("ðŸ“ æ­£åœ¨ç”Ÿæˆæ¡ˆä¾‹æ‘˜è¦...")
        
        try:
            # æ ¼å¼åŒ–æœç´¢çµæžœç‚ºæ˜“æ–¼è™•ç†çš„æ ¼å¼
            formatted_input = self._format_search_results_for_summary(search_results)
            
            # â­ é‡è¦ï¼šå‚³éžç”¨æˆ¶åŽŸå§‹æŸ¥è©¢ï¼Œè®“ Agent èƒ½åˆ¤æ–·ç›¸é—œæ€§
            prompt = f"""ã€ç”¨æˆ¶åŽŸå§‹æŸ¥è©¢ã€‘
"{user_query}"

ã€æœç´¢çµæžœã€‘
{formatted_input}

ã€åš´æ ¼ç›¸é—œæ€§åˆ¤æ–·æ¨™æº–ã€‘
ä½¿ç”¨ä»¥ä¸‹æ¨™æº–åˆ¤æ–·æœç´¢çµæžœæ˜¯å¦èˆ‡ç”¨æˆ¶æŸ¥è©¢ç›¸é—œï¼š

1. **å…¬å¸/çµ„ç¹”åç¨±åŒ¹é…** ðŸ¢
   - å¦‚æžœç”¨æˆ¶æŸ¥è©¢ç‰¹å®šå…¬å¸åç¨±ï¼ˆä¾‹å¦‚ï¼šå°ç©é›»ã€åœ‹æ³°è­‰åˆ¸ã€æŸæŸéŠ€è¡Œï¼‰ï¼Œ
     å‰‡æœç´¢çµæžœä¸­å¿…é ˆæ˜Žç¢ºåŒ…å«è©²å…¬å¸æˆ–å…¶å­å…¬å¸/é—œè¯ä¼æ¥­
   - å¦‚æžœæœç´¢çµæžœä¸­çš„å…¬å¸èˆ‡æŸ¥è©¢å®Œå…¨ä¸åŒï¼Œè¦–ç‚ºç„¡é—œ
   - ä¾‹å¦‚ï¼šç”¨æˆ¶æŸ¥ã€Œå°ç©é›»ã€ âœ— æœåˆ°ã€Œåœ‹æ³°è­‰åˆ¸ã€ç„¡é—œ

2. **é•è¦è¡Œç‚º/äº‹é …åŒ¹é…** âš–ï¸
   - å¦‚æžœç”¨æˆ¶æŸ¥è©¢ç‰¹å®šé•è¦è¡Œç‚ºï¼ˆä¾‹å¦‚ï¼šå…§ç·šäº¤æ˜“ã€è²¡å‹™ä½œå‡ã€åˆ©ç›Šè¡çªï¼‰ï¼Œ
     å‰‡æœç´¢çµæžœå¿…é ˆåŒ…å«è©²é•è¦è¡Œç‚º
   - å¦‚æžœæœç´¢çµæžœä¸­æ²’æœ‰ç”¨æˆ¶æŸ¥è©¢çš„å…·é«”é•è¦è¡Œç‚ºï¼Œè¦–ç‚ºç„¡é—œ
   - ä¾‹å¦‚ï¼šç”¨æˆ¶æŸ¥ã€Œå…§ç·šäº¤æ˜“æ¡ˆä¾‹ã€ âœ— æœåˆ°ã€Œä¸å¯¦å»£å‘Šæ¡ˆä¾‹ã€ç„¡é—œ

3. **é—œéµè©žç›´æŽ¥åŒ¹é…** ðŸ”
   - æª¢æŸ¥æœç´¢çµæžœä¸­æ˜¯å¦å‡ºç¾ç”¨æˆ¶æŸ¥è©¢ä¸­çš„æ ¸å¿ƒé—œéµè©ž
   - ä¸è¦æŽ¥å—æ¨¡ç³Šæˆ–é–“æŽ¥çš„é—œè¯
   - ä¾‹å¦‚ï¼šç”¨æˆ¶æŸ¥ã€Œèžè³‡èžåˆ¸é•è¦ã€ âœ— åªæœåˆ°ã€Œè‚¡ç¥¨äº¤æ˜“è¦ç¯„ã€ä¸ç®—ç›¸é—œ

ã€åˆ¤æ–·é‚è¼¯ã€‘
ç›¸é—œæ€§åˆ¤æ–·ç‚º âœ…ï¼ˆç›¸é—œï¼‰çš„æ¢ä»¶ï¼š
- å…¬å¸åç¨±å®Œå…¨æˆ–ç›´æŽ¥ç›¸é—œ AND
- é•è¦äº‹é …èˆ‡æŸ¥è©¢åŒ¹é… AND  
- æœç´¢çµæžœä¸­æ˜Žç¢ºåŒ…å«ç”¨æˆ¶æŸ¥è©¢çš„æ ¸å¿ƒå…§å®¹

ç›¸é—œæ€§åˆ¤æ–·ç‚º âŒï¼ˆç„¡é—œï¼‰çš„æ¢ä»¶ï¼š
- å…¬å¸åç¨±ä¸åŒ¹é… OR
- é•è¦äº‹é …/è¡Œç‚ºä¸ç¬¦åˆæŸ¥è©¢ OR
- æœç´¢çµæžœå…§å®¹å®Œå…¨ä¾†è‡ªä¸åŒé ˜åŸŸ/ä¸»é«”

ã€ä»»å‹™ã€‘
1. æ ¹æ“šä¸Šè¿°åš´æ ¼æ¨™æº–ï¼Œåˆ¤æ–·æœç´¢çµæžœæ˜¯å¦èˆ‡ç”¨æˆ¶æŸ¥è©¢ç›¸é—œ
2. å¦‚æžœç›¸é—œ âœ…ï¼šç”Ÿæˆæ‘˜è¦ä¸¦è©¢å•æ˜¯å¦æ·±å…¥åˆ†æžï¼Œè¼¸å‡ºã€ç­‰å¾…æ·±å…¥åˆ†æžç¢ºèªã€‘
3. å¦‚æžœç„¡é—œ âŒï¼š
   - æ˜Žç¢ºèªªæ˜Žç‚ºä»€éº¼ä¸ç›¸é—œï¼ˆå“ªäº›éƒ¨åˆ†ä¸ç¬¦åˆæŸ¥è©¢ï¼‰
   - é“æ­‰ä¸¦è©¢å•ç”¨æˆ¶ä¸‹ä¸€æ­¥æ„é¡˜
   - å¯ä»¥è©¢å•æ˜¯å¦è¦é‡æ–°æœç´¢ã€é€²è¡Œå…¶ä»–åˆ†æžæˆ–çµæŸ"""
            
            # å•Ÿå‹•æ‘˜è¦ç”Ÿæˆå°è©±
            chat_result = user_proxy.get_proxy().initiate_chat(
                self.agent,
                message=prompt,
                max_turns=2
            )
            
            # æå–çµæžœ
            response = await self.process_chat_result(chat_result)
            
            # æ›´æ–°è¨Šæ¯
            formatted_response = self.format_response(response, "ðŸ“‹")
            await self.update_message(summary_msg, formatted_response)
            
            return {
                "content": response,
                "success": True,
                "message": summary_msg
            }
            
        except Exception as e:
            await self.log_error(e)
            error_msg = f"ç”Ÿæˆæ‘˜è¦æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}"
            await self.update_message(summary_msg, error_msg)
            return {
                "content": error_msg,
                "success": False,
                "message": summary_msg
            }
    
    def _format_search_results_for_summary(self, search_results: Dict) -> str:
        """
        å°‡æœç´¢çµæžœæ ¼å¼åŒ–ç‚ºæ‘˜è¦ç”Ÿæˆçš„è¼¸å…¥

        Args:
            search_results: æœç´¢çµæžœå­—å…¸

        Returns:
            æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²
        """
        documents = search_results.get('ranked_documents', [])
        metadatas = search_results.get('ranked_metadatas', [])
        ids = search_results.get('ids', [])

        if not documents:
            return "æœªæ‰¾åˆ°ç›¸é—œæ¡ˆä¾‹ã€‚"

        formatted = f"ç¸½å…±æ‰¾åˆ° {len(documents)} å€‹ç›¸é—œæ¡ˆä¾‹ï¼š\n\n"

        for i, (doc, metadata, case_id) in enumerate(zip(documents, metadatas, ids)):
            formatted += f"æ¡ˆä¾‹ {case_id}:\n"

            # æ·»åŠ å…ƒæ•¸æ“šä¿¡æ¯
            if metadata:
                if 'å—è™•åˆ†äºº' in metadata:
                    formatted += f"å—è™•åˆ†äºº: {metadata['å—è™•åˆ†äºº']}\n"
                if 'ç™¼æ–‡æ—¥æœŸ' in metadata:
                    formatted += f"ç™¼æ–‡æ—¥æœŸ: {metadata['ç™¼æ–‡æ—¥æœŸ']}\n"
                if 'é•è¦äº‹å¯¦' in metadata:
                    formatted += f"é•è¦äº‹å¯¦: {metadata['é•è¦äº‹å¯¦']}\n"
                if 'è™•åˆ†å…§å®¹' in metadata:
                    formatted += f"è™•åˆ†å…§å®¹: {metadata['è™•åˆ†å…§å®¹']}\n"
                if 'z3code' in metadata and metadata['z3code']:
                    formatted += f"åŒ…å«ç¨‹å¼ç¢¼: æ˜¯\n"

            # æ·»åŠ æ–‡æª”å…§å®¹æ‘˜è¦
            content_preview = doc[:500] + "..." if len(doc) > 500 else doc
            formatted += f"å…§å®¹æ‘˜è¦: {content_preview}\n\n"

            # é™åˆ¶è™•ç†çš„æ¡ˆä¾‹æ•¸é‡
            if i >= 4:  # åªè™•ç†å‰5å€‹æ¡ˆä¾‹
                break

        if len(documents) > 5:
            formatted += f"...é‚„æœ‰ {len(documents) - 5} å€‹æ¡ˆä¾‹\n"

        return formatted